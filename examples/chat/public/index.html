<html>
  <head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//code.responsivevoice.org/responsivevoice.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.js"></script>
<script>
    var socket = io();
    var notificationQueue = [];
    var speaking = false;

    socket.on('new_notification', function (data) {
      console.log(data);
      notificationQueue.push(data);
    });

    socket.on('hb_leaderboard', function (data) {
      console.log(data);
    });
    $.get('/hb-leaderboard');

    var intervalID = setInterval(function(){
    	if(!speaking && notificationQueue.length > 0) {
    	  speakOut(notificationQueue[0])
    	}
    }, 1000);

    var speakOut = function(data) {
      speaking = true
      console.log('speakout: ');
      console.log(data);

      if(data.message == 'hb error resolved'){
        $('body').css('background-image', 'url(http://i.redsnapperverytasty.com/graphics/wp-content/uploads/2012/08/bill-murray-youre-awesome-500x648.jpg)');

        if(data.assignee){
          sound_message = "Hey " + data.assignee + "You are awesome."
          responsiveVoice.speak(sound_message, "UK English Female", {onend: speakEnd});
        }
      } else {
        blink()
        $('#error-message').html(data.message);
        if(data.mp3_slug !== '') {
          $('#'+data.mp3_slug)[0].play()
          $('#'+data.mp3_slug).bind("ended", function(){
            responsiveVoice.speak(data.message, "UK English Female", {onend: speakEnd});
          });
        } else {
          responsiveVoice.speak(data.message, "UK English Female", {onend: speakEnd});
        }
      }
    }

    function blink() {
      var on = 1;
      var led = document.getElementById("led");
      // inter_val = window.setInterval(function () { on = 1 - on; led.className = on ? "on" : "off"; }, 1000);
      interval = setInterval(function(){
        $("body").toggleClass("red-light");
      },100)
      setTimeout(function(){
        if(interval){
          $('#error-message').html('All is well here.');
          $("body").removeClass("red-light");
          clearInterval(interval);
        }
      }, 10000)
    }

    var speakEnd = function(){
      speaking = false;
      if(notificationQueue.length != 0) {
        notificationQueue.shift();
      }
    }


    var speakOut = function(data) {
      speaking = true
      console.log('speakout: ');
      console.log(data);
      blink()
      $('#error-message').html(data.message);
      if(data.mp3_slug !== '') {
        $('#'+data.mp3_slug)[0].play()
        $('#'+data.mp3_slug).bind("ended", function(){
          responsiveVoice.speak(data.message, "UK English Female", {onend: speakEnd});
        });
      } else {
        responsiveVoice.speak(data.message, "UK English Female", {onend: speakEnd});
      }
    }



   </script>

<style>

  .center-screen{
      position: fixed;
      top: 30%;
      width: 100%;
  }

  div #error-message{
    font-size: 70px;
    text-align: center
  }

  .red-light{
    width: 100%;
    width: 100%;
    color: red;
    background-color: red;
  }

  .hide {
    visibility: hidden;
  }
</style>
  </head>
  <body>
    <audio id="slimshady" style="display:none" controls>
      <source src="slimshady.mp3" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
    <audio id="siren" style="display:none" controls>
      <source src="siren.mp3" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
      <div class='center-screen'>
          <h1 id='error-message'>All is well here.</h1>
      </div>
  </body>
</html>
